-- This file and its contents are licensed under the Timescale License.
-- Please see the included NOTICE for copyright information and
-- LICENSE-TIMESCALE for a copy of the license.
\c :TEST_DBNAME :ROLE_SUPERUSER
\set VERBOSITY default
CREATE OR REPLACE FUNCTION generate_key() RETURNS text
AS :TSL_MODULE_PATHNAME, 'ts_pg_generate_key' LANGUAGE C VOLATILE;
CREATE OR REPLACE FUNCTION check_key(text) RETURNS bool
AS :TSL_MODULE_PATHNAME, 'ts_pg_check_key' LANGUAGE C VOLATILE;
-- Check that they function does not return null and succeeds
-- generating something that looks key.
SELECT generate_key() LIKE E'-----BEGIN PRIVATE KEY-----%-----END PRIVATE KEY-----\n' AS is_pkcs8;
 is_pkcs8 
----------
 t
(1 row)

-- Check that the checking function works for a correct key
SELECT check_key($$
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC8QlRR9u0UNO1S
n4yLeJnz+x9n2AijxRaHG8Kg4OT2wACHiiA83b7WfQ+5KgGxQmg7a794SEEa88W+
1OeAf+B+R6vw5RSYktPvYbP9ayDUYh4u31DxXarwpHZt0rHBvUR8F9wfjN50FTcn
sdx4M39aXzDkQAOGtj0jDhoC9pWi/QlYb8dUkMCIKAj4LkXsRAEDMHBRj8QXlvo+
lpl6iaMnAMc8MNmiq7NShND8B9hav1kIx+rQ8iqZLx1eMQ7042imwMlnAndhkEcC
j1EdF609mOBCXJMPiLPqflhM5tPpfK9fyIn/z7mrRu+aEFflv4sRP2AR9BShcam+
23f9mIh/AgMBAAECggEBAKXY7T2UAgHGKriaFA+efEojFeS+vcXAz/rQquJdnXf/
Z7gAKCxW0VNVs29VIU6OiRKn9nK5fJmI3dEi8JsUjKnS7Bd5SG6tEwYVFaKQKMjR
c3Opij5IXVpIGIjhj3V1Dosf3ezxhdvQANn4Z5iBDZWIvKKn/jNEApIKT0IDB4og
S0OfCbkyOGStMrPSmfnfm6l+oMJBn2xAb3K24rARYPf8ZX8cLE18HGfOPAO9FohR
DQmzh1V2ElVgjCAqxS3SZU4B6CyDSNnz4F4vrTyoVH9LMqb6XBRdKLtGdXFOSIJK
gHiID4s0bAI4N32SzOsNBNmAr9KvCs1MT+TC7MZZnjECgYEA5oDfM8+O+ox2Os9Z
3NZL71hvPghm9ZDvxnqEhhti6GsNRyngJil4aF6n0QTFRF1g0vMGdtTIYWJoeZiP
ebVUdXSli4FTlC0jR16tcODUXJhO6o1zpsP97zsF5CJiDliKhlMnhKdkpDUUT0BO
g3wqVhde1YPcSUJPBc5RNcVqOzcCgYEA0RU7cgKoyuoP6FMiOFp9gmpm6L0ZbAhv
HN9KLrCphB0pZgKn13dWEvAFQwkTXPPVW/ZsEiAiiGUfBX7OeMiRbHKRVmgip5H2
m6SlEMF5AHiGKUGVpHSvQFKW70h0Qpl31/j4cTvKziH40QULFSDKDo1+Qk80lACJ
6uAQXl66kPkCgYAhY2dxZM5MIo55pFFa+LuVFtU+Qg9P4Meqk1Kg7lScX+1TcpBi
Vr13OMbMMwm0BmahB8zW56mC2bNScbPOqGJshRH5rCkEHKmwi9lJsXdxViqQNR8c
d+VPgtgunIBhnZerL15ZC7o7QukHNcRprVGgmNAG04vUHMO/jowa4tapbwKBgDeM
sJKF6lqe/UL4c2sNf7MameTT+OEfDIZbPNZS0XbsWIdlxToV1qSJaJx62M4lalZY
jjXym7opQ6iuHCUzBJAPkFWorSxgN2j6wXBGNuPNIbfsWNmstrMcPkWstlbLd2/G
EhvjiuphVD4UXPFsGMLtDNKJQKrhycLBbRfliyPhAoGAHa+TbqrZmlOyVCj8SHzt
0NHDr+aCU11WLKn53W1BPG+qrorRoCkWIQXXa7ljzE97i4v62TpkXjgkGc4V0fcJ
D643UDpQSkZ6XhUDdyxaq045VDbLxlA6Cf2umBU5vzqj7JX/aRdm71JPX2nJTNTW
tRaLv9x0OvEVorRkqMlipK4=
-----END PRIVATE KEY-----
$$);
 check_key 
-----------
 t
(1 row)

-- Check that the checking function does not work for an incorrectly
-- formatted key. We have just removed a dash from the armour.
\set ON_ERROR_STOP 0
SELECT check_key($$
----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC8QlRR9u0UNO1S
n4yLeJnz+x9n2AijxRaHG8Kg4OT2wACHiiA83b7WfQ+5KgGxQmg7a794SEEa88W+
1OeAf+B+R6vw5RSYktPvYbP9ayDUYh4u31DxXarwpHZt0rHBvUR8F9wfjN50FTcn
sdx4M39aXzDkQAOGtj0jDhoC9pWi/QlYb8dUkMCIKAj4LkXsRAEDMHBRj8QXlvo+
lpl6iaMnAMc8MNmiq7NShND8B9hav1kIx+rQ8iqZLx1eMQ7042imwMlnAndhkEcC
j1EdF609mOBCXJMPiLPqflhM5tPpfK9fyIn/z7mrRu+aEFflv4sRP2AR9BShcam+
23f9mIh/AgMBAAECggEBAKXY7T2UAgHGKriaFA+efEojFeS+vcXAz/rQquJdnXf/
Z7gAKCxW0VNVs29VIU6OiRKn9nK5fJmI3dEi8JsUjKnS7Bd5SG6tEwYVFaKQKMjR
c3Opij5IXVpIGIjhj3V1Dosf3ezxhdvQANn4Z5iBDZWIvKKn/jNEApIKT0IDB4og
S0OfCbkyOGStMrPSmfnfm6l+oMJBn2xAb3K24rARYPf8ZX8cLE18HGfOPAO9FohR
DQmzh1V2ElVgjCAqxS3SZU4B6CyDSNnz4F4vrTyoVH9LMqb6XBRdKLtGdXFOSIJK
gHiID4s0bAI4N32SzOsNBNmAr9KvCs1MT+TC7MZZnjECgYEA5oDfM8+O+ox2Os9Z
3NZL71hvPghm9ZDvxnqEhhti6GsNRyngJil4aF6n0QTFRF1g0vMGdtTIYWJoeZiP
ebVUdXSli4FTlC0jR16tcODUXJhO6o1zpsP97zsF5CJiDliKhlMnhKdkpDUUT0BO
g3wqVhde1YPcSUJPBc5RNcVqOzcCgYEA0RU7cgKoyuoP6FMiOFp9gmpm6L0ZbAhv
HN9KLrCphB0pZgKn13dWEvAFQwkTXPPVW/ZsEiAiiGUfBX7OeMiRbHKRVmgip5H2
m6SlEMF5AHiGKUGVpHSvQFKW70h0Qpl31/j4cTvKziH40QULFSDKDo1+Qk80lACJ
6uAQXl66kPkCgYAhY2dxZM5MIo55pFFa+LuVFtU+Qg9P4Meqk1Kg7lScX+1TcpBi
Vr13OMbMMwm0BmahB8zW56mC2bNScbPOqGJshRH5rCkEHKmwi9lJsXdxViqQNR8c
d+VPgtgunIBhnZerL15ZC7o7QukHNcRprVGgmNAG04vUHMO/jowa4tapbwKBgDeM
sJKF6lqe/UL4c2sNf7MameTT+OEfDIZbPNZS0XbsWIdlxToV1qSJaJx62M4lalZY
jjXym7opQ6iuHCUzBJAPkFWorSxgN2j6wXBGNuPNIbfsWNmstrMcPkWstlbLd2/G
EhvjiuphVD4UXPFsGMLtDNKJQKrhycLBbRfliyPhAoGAHa+TbqrZmlOyVCj8SHzt
0NHDr+aCU11WLKn53W1BPG+qrorRoCkWIQXXa7ljzE97i4v62TpkXjgkGc4V0fcJ
D643UDpQSkZ6XhUDdyxaq045VDbLxlA6Cf2umBU5vzqj7JX/aRdm71JPX2nJTNTW
tRaLv9x0OvEVorRkqMlipK4=
-----END PRIVATE KEY-----
$$);
ERROR:  key import error
DETAIL:  Error: no start line
-- Check a key where we have swapped two letters. Should result in an
-- incorrect key and should be caught by the checking function.
SELECT check_key($$
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC8QlRR9u0UNO1S
n4yLeJnz+x9n2AijxRaHG8Kg4OT2wACHiiA83b7WfQ+5KgGxQmg7a794SEEa88W+
1OeAf+B+R6vw5RSYktPvYbP9ayDUYh4u31DxXarwpHZt0rHBvUR8F9wfjN50FTcn
sdx4M39aXzDkQAOGtj0jDhoC9pWi/QlYb8dUkMCIKAj4LkXsRAEDMHBRj8QXlvo+
lpl6iaMnAMc8MNmiq7NShND8B9hav1kIx+rQ8iqZLx1eMQ7042imwMlnAndhkEcC
j1EdF609mOBCXJMPiLPqflhM5tPpfK9fyIn/z7mrRu+aEFflv4sRP2AR9BShcam+
23f9mIh/AgMBAAECggEBAKXY7T2UAgHGKriaFA+efEojFeS+vcXAz/rQquJdnXf/
Z7gAKCxW0VNVs29VIU6OiRKn9nK5fJmI3dEi8JsUjKnS7Bd5SG6tEwYVFaKQKMjR
c3Opij5IXVpIGIjhj3V1Dosf3ezxhdvQANn4Z5iBDZWIvKKn/jNEApIKT0IDB4og
S0OfCbkyOGStMrPSmfnfm6l+oMJBn2xAb3K24rARYPf8ZX8cLE18HGfOPAO9FohR
DQmzh1V2ElVgjCAqxS3SZU4B6CyDSNnz4F4vrTyoVH9LMqb6XBRdKLtGdXFOSIJK
gHiID4s0bAI4N32SzOsNBNmAr9KvCs1MT+TC7MZZnjECgYEA5oDfM8+O+ox2Os9Z
3NZL71hvPghm9ZDvxnqEhhti6GsNRyngJil4aF6n0QTFRF1g0vMGdtTIYWJoeZiP
ebVUdXSli4FTlC0jR16tcODUXJhO6o1zpsP97zsF5CJiDliKhlMnhKdkpDUUT0BO
g3wqVhde1YPcSUJPBc5RNcVqOzcCgYEA0RU7cgKoyuoP6FMiOFp9gmpm6L0ZbAhv
HN9KLrCphB0pZgKn13dWEvAFQwkTXPPVW/ZsEiAiiGUfBX7OeMiRbHKRVmgip5H2
m6SlEMF5AHiGKUGVpHSvQFKW70h0Qpl31/j4cTvKziH40QULFSDKDo1+Qk80lACJ
6uAQXl66kPkCgYAhY2dxZM5MIo55pFFa+LuVFtU+Qg9P4Meqk1Kg7lScX+1TcpBi
Vr13OMbMMwm0BmahB8zW56mC2bNScbPOqGJshRH5rCkEHKmwi9lJsXdxViqQNR8c
d+VgPtgunIBhnZerL15ZC7o7QukHNcRprVGgmNAG04vUHMO/jowa4tapbwKBgDeM
sJKF6lqe/UL4c2sNf7MameTT+OEfDIZbPNZS0XbsWIdlxToV1qSJaJx62M4lalZY
jjXym7opQ6iuHCUzBJAPkFWorSxgN2j6wXBGNuPNIbfsWNmstrMcPkWstlbLd2/G
EhvjiuphVD4UXPFsGMLtDNKJQKrhycLBbRfliyPhAoGAHa+TbqrZmlOyVCj8SHzt
0NHDr+aCU11WLKn53W1BPG+qrorRoCkWIQXXa7ljzE97i4v62TpkXjgkGc4V0fcJ
D643UDpQSkZ6XhUDdyxaq045VDbLxlA6Cf2umBU5vzqj7JX/aRdm71JPX2nJTNTW
tRaLv9x0OvEVorRkqMlipK4=
-----END PRIVATE KEY-----
$$);
ERROR:  RSA key error
DETAIL:  Error: dmp1 not congruent to d
\set ON_ERROR_STOP 1
-- Check that the generation function generates a key that can be
-- checked by the checking function.
SELECT check_key(generate_key()) AS checks_ok;
 checks_ok 
-----------
 t
(1 row)

