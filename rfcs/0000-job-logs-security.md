# Summary

Job log visibility

# Rationale

For this document, we have a few different roles that should have
different visibility into the system.

**Service Administrator**
: For hosted environments, this is the administrator of the service or
  platform deplying the database. They usually have more extensive
  privileges, typically `SUPERUSER` privileges, since they need to
  have better control of the entire deployment. This is typically the
  `postgres` user.

**Database Administrator**
: This is the administrator of the database system. For hosted
  environments this is different from the platform administrator and
  typically do not have privileges to modify or affect the platform
  installation, but typically have `CREATEROLE` privileges. For
  Timescale Cloud, this is `tsadmin`

**Other roles**
: These are any other roles or users. They can have different kinds of
  privileges, but they are typically created by the database
  administrator (if she has `CREATEROLE` privileges) who also assign
  privileges to them.

## Situation

We have background worker jobs to perform different tasks. There are a
few pre-defined jobs that are always started, and some of these jobs
are created as a result of creating policies, but it is also possible
to add custom jobs.

Some examples of jobs are:

Telemetry Reporter
: Sends telemetry data on a daily basis. On hosted environments, this
  should be available to the database administrator.

Refresh Continuous Aggregate Policy
: Refresh continuous aggregates

Error Log Retention Policy
: Remove old error log entries

Service-specific Job
: Some job that is available on the service and which are not under
  control of the database administrator.

User-specific job
: Jobs created by a user 

When jobs execute and generate warnings or errors, these are written
to the table `_timescaledb_internal.job_errors`, which is publicly
visible.

For convenience, there is an informational view
`timescaledb_information.job_errors` in a user-friendly form.

with the following columns:

| Column Name   | Description      |
|---------------|------------------|
| `job_id`      | Job ID           |
| `proc_schema` | Procedure Schema |
| `proc_name`   | Procedure Name   |
| `pid`         | Process ID       |
| `start_time`  | Start time of                  |

## Problem

Errors contain a lot of information, and occationally information that
should not be revealed to users that do not have the right
privileges. Typically, the user should only be able to view lines
generated by jobs she own, or by jobs owned by a role that she belongs
to.

## Expected outcome

Only users that are the official owner of a job should be able to view
entries generated by the job.

It should be possible to set a role different than the current user
for a job.

# Reference-level description

The entries below just provide the additional information that needs
to be added. It does not contain a full description of the commands.

## Additions to alter_job()

To alter a job you need to be the owner of the job or belong to the
role that owns the job.

### Optional arguments

| Name    | Type    | Description                                       |
|---------|---------|---------------------------------------------------|
| `owner` | REGROLE | Role of job owner. Default value is current user. |

**owner**
: To assign a different role to the job than the current user, you can
  use the `owner` parameter, but you are only allowed to assign a role
  that you are a member of.


## Additions to add_job()

### Optional arguments

| Name    | Type    | Description                                       |
|---------|---------|---------------------------------------------------|
| `owner` | REGROLE | Role of job owner. Default value is current user. |

**owner**
: To assign a different role to the job than the current user, you can
  use the `owner` parameter, but you are only allowed to assign a role
  that you are a member of.

## Additions to `timescaledb_information.job_errors`

Only lines generated by jobs owned by you or owned by a role that you
are a member of will be visible.

# Open Issues

Issues remaining to resolve either by incorporating them into the
design or discard them (with a reason for why). This section is
usually empty once the RFC is ready, but there is no strict
requirement that is has to be empty.

# Future work

Work that is not included, but which might be interesting to follow up
with in a future RFC.

# Status

| **Issue**   | Link to issue |
| **Version** | Version added |
